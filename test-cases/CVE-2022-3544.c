/* "DAMON is a data access monitoring framework subsystem for the Linux kernel." -Linux Kernel Archives 
#include <linux/damon.h> is line 8 in the file
also ctx = context?? couldn't find any declarations/definitions
*/


int damon_new_target() {
  return 0;
}

bool damon_target_has_pid(x) {
  return true;
}

bool find_get_pid(x) {
  return true;
}

int damon_add_target(x, y) {
  return 0;
}

static int damon_sysfs_set_regions(struct damon_target *t,
		struct damon_sysfs_regions *sysfs_regions) { //???
  break;
}

/* found these two at https://android.googlesource.com/kernel/common/+/refs/heads/android-mainline/mm/damon/core.c so i'm not 100% sure it's from the linux kernel but i think it is

Comments: "Construct a damon_target struct" and "Returns the pointer to the new struct if success, or NULL otherwise"
 
struct damon_target *damon_new_target(void)
{
	struct damon_target *t;
	t = kmalloc(sizeof(*t), GFP_KERNEL);
	if (!t)
		return NULL;
	t->pid = NULL;
	t->nr_regions = 0;
	INIT_LIST_HEAD(&t->regions_list);
	INIT_LIST_HEAD(&t->list);
	return t;
 }
 
void damon_add_target(struct damon_ctx *ctx, struct damon_target *t)
{
	list_add_tail(&t->list, &ctx->adaptive_targets);
}
*/

static void damon_sysfs_destroy_targets(struct damon_ctx *ctx)
{
	struct damon_target *t, *next;

	damon_for_each_target_safe(t, next, ctx) {
		if (damon_target_has_pid(ctx))
			put_pid(t->pid);
		damon_destroy_target(t);
	}
}

static int damon_sysfs_add_target(struct damon_sysfs_target *sys_target,
		struct damon_ctx *ctx)
{
	struct damon_target *t = damon_new_target(); //only time damon_new_target is written in this file
	int err = -EINVAL;

	if (!t)
		return -ENOMEM;
	//here add damon_add_target(ctx, t);
	if (damon_target_has_pid(ctx)) {
		t->pid = find_get_pid(sys_target->pid);
		if (!t->pid)
			goto destroy_targets_out; //????
	}
	damon_add_target(ctx, t); //remove this ** THIS IS THE ONLY TIME IN THE FILE DAMON_ADD_TARGET IS WRITTEN
	err = damon_sysfs_set_regions(t, sys_target->regions);
	if (err)
		goto destroy_targets_out;
	return 0;

destroy_targets_out:
	damon_sysfs_destroy_targets(ctx);
	return err;
}
