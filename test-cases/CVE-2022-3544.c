#include "CVE-2022-3544.h"

struct pid;
struct pid *find_get_pid(int nr) {
  return 0;
};

void damon_for_each_target_safe(struct damon_target *t,
                                struct damon_target *next,
                                struct damon_ctx *ctx);

static void damon_del_target(struct damon_target *t) { list_del(&t->list); }

void damon_free_target(struct damon_target *t) // deallocation site?
{
  struct damon_region *r, *next;

  damon_for_each_region_safe(r, next, t);
  damon_free_region(r);
  kfree(t);
}

void damon_destroy_target(struct damon_target *t) {
  damon_del_target(t);
  damon_free_target(t);
}

static void damon_sysfs_destroy_targets(struct damon_ctx *ctx) {
  struct damon_target *t, *next;
  bool has_pid = damon_target_has_pid(ctx);

  damon_for_each_target_safe(t, next, ctx);
  {
    if (has_pid)
      put_pid(t->pid);
    damon_destroy_target(t);
  }
}

static int damon_sysfs_add_target(struct damon_sysfs_target *sys_target,
                                  struct damon_ctx *ctx) {
  struct damon_target *t = damon_new_target();
  int err = -EINVAL;

  if (!t)
    return -ENOMEM;
  // here add damon_add_target(ctx, t);
  if (damon_target_has_pid(ctx)) {
    t->pid = find_get_pid(sys_target->pid);
    if (!t->pid)
      goto destroy_targets_out;
  }
  damon_add_target(ctx, t); // remove this
  err = damon_sysfs_set_regions(t, sys_target->regions);
  if (err)
    goto destroy_targets_out;
  return 0;

destroy_targets_out:
  damon_sysfs_destroy_targets(ctx);
  return err;
}

void main() {
  struct damon_sysfs_target *st;
  struct damon_ctx *ctx;
  damon_sysfs_add_target(st, ctx);
}